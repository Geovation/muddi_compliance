WITH network AS
    (INSERT INTO muddi.network (record_id, object_id, geom, asset_owner_id, commodity_type, network_type, network_name)
    SELECT 
        uuid_generate_v4(),
        uuid_generate_v4(),
        st_collect(shape),
        'Northern Gas Networks',
        'gas',
        'network',
        'NGN'
    FROM import.gasline_live_distribution_main_pipe
    RETURNING system_id 
),
subnetwork AS
    (INSERT INTO muddi.network (record_id, object_id, geom, asset_owner_id, commodity_type, parent_network_id, network_type, network_name)
    SELECT 
        uuid_generate_v4(),
        uuid_generate_v4(),
        st_collect(import.shape),
        'Northern Gas Networks',
        'gas',
        system_id,
        'subnetwork',
        import.networkid
    FROM network, import.gasline_live_distribution_main_pipe as import
    group by import.networkid, system_id
    RETURNING parent_network_id 
)
INSERT INTO muddi.network (record_id, object_id, geom, asset_owner_id, commodity_type, parent_network_id, network_type, network_name)
SELECT 
    uuid_generate_v4(),
    uuid_generate_v4(),
    st_collect(import.shape),
    'Northern Gas Networks',
    'gas',
    parent_network_id,
    'subordinate network',
    import.assettype
FROM subnetwork, import.gasline_live_distribution_main_pipe as import
GROUP BY import.assettype, parent_network_id;


-- INGEST SERVICE AREA 


-- CREATE NODE TABLE
CREATE TABLE staging.nodes AS
SELECT 
	gen_random_uuid() as record_id,
	networkid as network_name,
	geom,
	array_agg(leaving) AS leaving,
	array_agg(entering) AS entering
FROM (
  SELECT 
  	networkid,
    ST_StartPoint(st_linemerge(shape)) AS geom, 
    globalid::varchar AS leaving,
    NULL::varchar AS entering
  FROM public.gasline_live_distribution_main_pipe
  UNION ALL
  SELECT 
  	networkid,
    ST_EndPoint(st_linemerge(shape)) AS geom, 
    NULL::varchar AS leaving,
    globalid::varchar AS entering
  FROM public.gasline_live_distribution_main_pipe
) as foo
GROUP BY geom, networkid;


-- CREATE LINK TABLE 
CREATE TABLE staging.links AS
SELECT
    link.globalid::varchar AS record_id,
    link.shape AS geom,
    link.networkid as network_name,
    'pipe' AS conveyance_type,
    link.material,
    link.diameter,
    link.unitofdiameter as diameter_units,
    node1.nodeid::varchar AS starting_node,
    node2.nodeid::varchar AS ending_node
FROM public.gasline_live_distribution_main_pipe AS link
INNER JOIN (
    SELECT 
        record_id as nodeid,
        leaving_link as linkid
    FROM staging.nodes
    CROSS JOIN UNNEST(nodes.leaving) AS leaving_link) as node1
    ON link.globalid::varchar = node1.linkid 
INNER JOIN (
    SELECT 
        record_id AS nodeid,
        starting_link AS linkid
    FROM staging.nodes
    CROSS JOIN UNNEST(nodes.entering) AS starting_link) as node2
    ON link.globalid::varchar = node2.linkid;

-- INGEST NODES
INSERT INTO muddi.network_node (record_id, object_id, geom, asset_owner_id, utility_type, network_id, sub_network_id, subordinate_network_id, node_type)
SELECT 
    record_id,
    uuid_generate_v4(),
    geom,
    'Northern Gas Networks',
    'gas',
    network.system_id,
    subnetwork.system_id,
    subordinate_network.system_id,
    import.networkid
FROM staging.nodes;


-- INGEST LINKS
INSERT INTO muddi.network_link (record_id, object_id, geom, asset_owner_id, utility_type, network_id, sub_network_id, subordinate_network_id, node_type)
SELECT 
    record_id,
    uuid_generate_v4(),
    geom,
    'Northern Gas Networks',
    'gas',
    node_to.system_id,
    node_from.system_id
    network.system_id,
    subnetwork.system_id,
    subordinate_network.system_id,
    import.networkid
FROM staging.links as import
INNER JOIN muddi.network_node as nodes ON   ;
-- INGEST CONTAINER